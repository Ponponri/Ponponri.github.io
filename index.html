<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css"
    />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/gh/vanjs-org/van/public/van-1.2.7.nomodule.min.js"
    ></script>
    <title>旅行檢查清單</title>
  </head>

  <body>
    <main class="container">
      <h2>16bit-chip 旅行檢查清單</h2>
      <section></section>
    </main>
    <script>
      const { input, strong, table, tbody, td, th, tr, div, button } = van.tags;

      const defaultItems = [
        {
          種類: "隨身衣物",
          物品: "上衣",
          數量: "5~6件",
          備註: "",
          完成: false,
        },
        {
          種類: "隨身衣物",
          物品: "內衣 or 發熱衣",
          數量: "7~8件",
          備註: "",
          完成: false,
        },
        {
          種類: "隨身衣物",
          物品: "內褲",
          數量: "15件",
          備註: "",
          完成: false,
        },
        {
          種類: "隨身衣物",
          物品: "褲子",
          數量: "5~6件",
          備註: "",
          完成: false,
        },
        {
          種類: "隨身衣物",
          物品: "襪子",
          數量: "15件",
          備註: "",
          完成: false,
        },
        {
          種類: "隨身衣物",
          物品: "鞋子",
          數量: "2雙",
          備註: "防水注意",
          完成: false,
        },
        {
          種類: "睡衣",
          物品: "睡衣上衣",
          數量: "2件",
          備註: "",
          完成: false,
        },
        {
          種類: "睡衣",
          物品: "睡衣褲子",
          數量: "2件",
          備註: "",
          完成: false,
        },
        {
          種類: "其他防寒衣物",
          物品: "厚外套",
          數量: "1-2套",
          備註: "防寒注意",
          完成: false,
        },
        {
          種類: "其他防寒衣物",
          物品: "防寒手套",
          數量: "1雙",
          備註: "",
          完成: false,
        },
        {
          種類: "其他防寒衣物",
          物品: "耳罩",
          數量: "#",
          備註: "要不要帶看個人",
          完成: false,
        },
        {
          種類: "其他防寒衣物",
          物品: "圍巾",
          數量: "1個",
          備註: "",
          完成: false,
        },
        {
          種類: "其他防寒衣物",
          物品: "帽子",
          數量: "#",
          備註: "要不要帶看個人",
          完成: false,
        },
        {
          種類: "盥洗用具",
          物品: "牙刷、牙膏",
          數量: "1組",
          備註: "",
          完成: false,
        },
        {
          種類: "盥洗用具",
          物品: "毛巾",
          數量: "1~2條",
          備註: "",
          完成: false,
        },
        {
          種類: "盥洗用具",
          物品: "衛生紙",
          數量: "#",
          備註: "數量看個人狀況",
          完成: false,
        },
        {
          種類: "盥洗用具",
          物品: "刮鬍刀",
          數量: "1個",
          備註: "科皓X",
          完成: false,
        },
        {
          種類: "盥洗用具",
          物品: "酒精",
          數量: "1小瓶",
          備註: "",
          完成: false,
        },
        {
          種類: "盥洗用具",
          物品: "香香噴霧",
          數量: "1人1瓶",
          備註: "不洗衣物時使用",
          完成: false,
        },
        {
          種類: "盥洗用具",
          物品: "乳液、個人藥品",
          數量: "#",
          備註: "看個人狀況",
          完成: false,
        },
        {
          種類: "其他行李配備",
          物品: "行李箱",
          數量: "1個",
          備註: "需有1個行李秤、\n綁帶",
          完成: false,
        },
        {
          種類: "其他行李配備",
          物品: "個人隨身包包",
          數量: "1個",
          備註: "",
          完成: false,
        },
        {
          種類: "其他行李配備",
          物品: "雨傘",
          數量: "1個",
          備註: "",
          完成: false,
        },
        {
          種類: "其他行李配備",
          物品: "手機、充電設備",
          數量: "1組",
          備註: "",
          完成: false,
        },
        {
          種類: "其他行李配備",
          物品: "網卡",
          數量: "每人1份",
          備註: "要帶網卡針",
          完成: false,
        },
        {
          種類: "其他行李配備",
          物品: "水壺",
          數量: "1個",
          備註: "保溫熱水壺",
          完成: false,
        },
        {
          種類: "其他行李配備",
          物品: "紙、筆",
          數量: "#",
          備註: "1~2人攜帶",
          完成: false,
        },
        {
          種類: "其他行李配備",
          物品: "口罩",
          數量: "15個",
          備註: "",
          完成: false,
        },
        {
          種類: "***重要物品***",
          物品: "護照",
          數量: "1人1個",
          備註: "護照影本",
          完成: false,
        },
        {
          種類: "***重要物品***",
          物品: "機票",
          數量: "1人1張",
          備註: "",
          完成: false,
        },
        {
          種類: "***重要物品***",
          物品: "住宿證明",
          數量: "#",
          備註: "電子 + 紙本都帶",
          完成: false,
        },
        {
          種類: "***重要物品***",
          物品: "錢",
          數量: "日幣 + 少許台幣",
          備註: "",
          完成: false,
        },
        {
          種類: "***重要物品***",
          物品: "信用卡、金融卡",
          數量: "#",
          備註: "1-2人帶",
          完成: false,
        },
        {
          種類: "***重要物品***",
          物品: "兵役證明",
          數量: "免役",
          備註: "中景 (役男出境)",
          完成: false,
        },
      ];

      save = (items) => {
        localStorage.setItem("items", JSON.stringify(items));
      };

      const Swap = (showIdx = 0, ...children) => children[showIdx];

      const ItemList = (edit, items) => {
        const thMap = new Map();
        items.forEach((item) =>
          thMap.set(item["種類"], (thMap.get(item["種類"]) ?? 0) + 1)
        );
        return items.map((item) =>
          tr(
            () => {
              const rowspan = thMap.get(item["種類"]);
              if (rowspan) {
                thMap.delete(item["種類"]);
                return td({
                  rowspan,
                  style: "writing-mode: vertical-rl; text-orientation: upright",
                }, item["種類"]);
              }
            },
            td(
              Swap(
                edit.val ? 1 : 0,
                div(item["物品"]),
                input({
                  value: item["物品"],
                  onchange: (e) => item["物品"] = e.target.value,
                }),
              ),
            ),
            td(
              Swap(
                edit.val ? 1 : 0,
                div(item["數量"]),
                input({
                  value: item["數量"],
                  onchange: (e) => item["數量"] = e.target.value,
                }),
              ),
            ),
            td(
              Swap(
                edit.val ? 1 : 0,
                div(item["備註"]),
                input({
                  value: item["備註"],
                  onchange: (e) => item["備註"] = e.target.value,
                }),
              ),
            ),
            td(
              Swap(
                edit.val ? 1 : 0,
                input({
                  type: "checkbox",
                  checked: item["完成"],
                  onclick: (e) => ((item["完成"] = e.target.checked), save(items)),
                }),
                button(
                  { onclick: () => (save(items.filter((i) => !Object.is(i, item))), location.reload())},
                  "刪除",
                ),
              ),
            ),
          )
        );
      };

      const NewItem = (onAdd) => {
        const defaultItem = {
          "種類": "",
          "物品": "",
          "數量": "",
          "備註": "",
          "完成": false,
        };
        const newItem = van.state({ ...defaultItem });
        return tr(
          td(
            input({
              onchange: (e) => newItem.val["種類"] = e.target.value,
              value: newItem.val["種類"] ?? "",
            }),
          ),
          td(
            input({
              onchange: (e) => newItem.val["物品"] = e.target.value,
              value: newItem.val["物品"] ?? "",
            }),
          ),
          td(
            input({
              onchange: (e) => newItem.val["數量"] = e.target.value,
              value: newItem.val["數量"] ?? "",
            }),
          ),
          td(
            input({
              onchange: (e) => newItem.val["備註"] = e.target.value,
              value: newItem.val["備註"] ?? "",
            }),
          ),
          td(
            button(
              {
                onclick: () => (onAdd(newItem.val), newItem.val = { ...defaultItem }),
              },
              "新增",
            ),
          ),
        );
      };

      const Checklist = () => {
        let items = JSON.parse(localStorage.getItem("items")) ?? defaultItems;
        save(items);
        const edit = van.state(false);
        van.derive(() => save(items, edit.val));
        return div(
          () =>
            button(
              { onclick: () => edit.val = !edit.oldVal },
              edit.val ? "儲存" : "編輯",
            ),
          () =>
            table(
              tbody(
                tr(th("種類"), th("物品"), th("數量"), th("備註"), th("完成")),
                ItemList(edit, items),
                NewItem((
                  newItem,
                ) => (items.push(newItem), save(items))),
              ),
            ),
        );
      };

      van.add(document.querySelector("section"), Checklist());
    </script>
  </body>
</html>
